name: Data Pipeline - CAGED Agro

on:
  schedule:
    # Executa no dia 5 de cada mes as 8:00 UTC (5:00 BRT)
    # Dados CAGED sao divulgados ~25 dias apos o mes de referencia
    - cron: '0 8 5 * *'
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Forcar reconstrucao completa dos dados'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

concurrency:
  group: "data-pipeline"
  cancel-in-progress: false

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Cache data files
        id: cache-data
        uses: actions/cache@v4
        with:
          path: |
            data/raw
            data/processed
          key: caged-data-${{ github.run_number }}
          restore-keys: |
            caged-data-

      - name: Download CAGED data
        working-directory: scripts
        run: python download_caged_granular.py

      - name: Process dashboard data
        working-directory: scripts
        run: python prepare_dashboard_granular.py

      - name: Check for changes
        id: check
        run: |
          git add -A
          if git diff --cached --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push
        if: steps.check.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "$(cat <<'EOF'
          Atualiza dados CAGED Agro via pipeline automatico

          Download e processamento de microdados CAGED executados automaticamente.
          Dados filtrados para Parana e setores agropecuarios (CNAE).
          EOF
          )"
          git push

      - name: Summary
        run: |
          echo "## Data Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Data updated:** ${{ steps.check.outputs.changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          if [ -f "dashboard/public/data/aggregated_full.json" ]; then
            echo "- **Data file:** dashboard/public/data/aggregated_full.json" >> $GITHUB_STEP_SUMMARY
          fi
